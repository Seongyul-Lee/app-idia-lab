# 마음날씨 (MaumNalssi) — Product Requirements Document

> **문서 버전**: 3.0
> **작성일**: 2026-01-31
> **상태**: 3단계 완료
> **대상 아이디어**: 002-마음날씨

---

## 1. Executive Summary

**마음날씨**는 한국어 감정 어휘로 매일 감정을 기록하고, 데이터 기반으로 패턴을 분석하여 맞춤형 셀프케어 행동을 제안하는 감정 관리 앱이다.

**핵심 가치 제안**: "기록하고 끝"이 아닌, "기록 → 분석 → 행동"의 완결된 감정 관리 루프를 한국어 감정 문화에 맞게 제공한다.

### 왜 지금인가
- **필코노미 트렌드** (트렌드 코리아 2026): 감정 관리가 하나의 역량이자 소비 동기로 부상
- **시장 4배 성장**: 한국 기분 기록 앱 사용자 50만(2023) → 200만(2025) (와이즈앱)
- **시장 공백**: "기록 앱"(하루콩)과 "상담 앱"(마인드카페, 트로스트) 사이, "기록+분석+행동 제안"을 통합 제공하는 앱 부재

### 핵심 수치
| 항목 | 수치 |
|------|------|
| TAM | 글로벌 Mood Tracking Apps $61억 (2025) |
| SAM | 한국 감정 관리 앱 잠재 사용자 300~500만 명 |
| SOM (1년) | MAU 3~5만 명 (보수적) |
| 목표 수익 (1년) | 월 525만 원 (유료 1,500명 × 3,500원) |
| MVP 기간 | 2~3개월 |

---

## 2. Problem Statement

### 2-1. 핵심 문제

**"감정을 기록하고 나면, 그 다음은?"**

현재 한국 시장의 감정 관리 앱은 두 극단에 위치한다:

1. **기록 앱** (하루콩, MOODA, Daylio): 감정을 기록할 수 있지만, 기록 후 "그래서 어떻게 해야 하는가?"에 대한 답이 없음
2. **상담 앱** (마인드카페, 트로스트): 전문 상담을 제공하지만, 3~10만원/회 비용 부담 + 심리적 진입 장벽

이 두 극단 사이에 있는 대다수 사용자 — "전문 상담은 부담스럽지만, 단순 기록보다 더 능동적인 관리가 필요한" 사용자층 — 을 위한 서비스가 없다.

### 2-2. 세부 문제

| 문제 | 현 상태 | 영향 |
|------|---------|------|
| 기록 후 행동 부재 | 감정 기록 앱은 기록에서 끝남 | 사용자 이탈, 기록 습관 중단 |
| 한국어 감정 어휘 미반영 | 영어권 감정 체계를 번역한 수준 | '서운하다', '답답하다', '억울하다' 등 한국어 고유 감정 표현 불가 |
| 가격 공백 | 무료(기록 앱) vs 3~10만원(상담 앱) | 중간 가격대 셀프케어 서비스 부재 |
| 패턴 인지 부재 | 감정 변화의 원인/패턴을 사용자가 직접 파악해야 함 | 반복되는 부정적 패턴에 대한 사전 대응 불가 |

*근거: 2단계 시장분석 — 한국 감정 기록 앱 사용자 4배 성장(2023→2025, 와이즈앱), AI 심리상담 이용 의향 40% (한국리서치 2025)*

### 2-3. 기회 가설

> 한국어 감정 어휘에 특화된 간편 기록 + 데이터 기반 패턴 분석 + 맞춤형 셀프케어 행동 제안을 하나의 앱에서 제공하면, 기존 기록 앱 사용자의 이탈을 줄이고 유료 전환율을 높일 수 있다.

---

## 3. Target Users & Personas

### 3-1. 주요 페르소나

#### 페르소나 A: "감정 기록 이탈자" (핵심 타겟)
- **프로필**: 25세 여성 직장인, 하루콩 6개월 사용 후 중단
- **행동**: 감정 기록은 꾸준히 했지만, "그래서 뭘 해야 하는지" 몰라서 흥미를 잃음
- **니즈**: "내 감정 패턴을 알고 싶고, 기분이 안 좋을 때 뭘 하면 좋은지 알려줬으면"
- **지불 의향**: 월 3,000~5,000원 (커피 한 잔 가격)

#### 페르소나 B: "셀프케어 입문자"
- **프로필**: 29세 남성 개발자, 번아웃 경험 후 자기 관리에 관심
- **행동**: 심리상담은 아직 부담스럽고, 혼자서 감정을 다스리고 싶음
- **니즈**: "나도 모르게 반복되는 감정 패턴을 객관적으로 보고 싶다"
- **지불 의향**: 연간 구독 가능 (효과 확인 후)

#### 페르소나 C: "감정 분석 호기심형"
- **프로필**: 22세 대학생, MBTI/심리테스트를 자주 하는 Z세대
- **행동**: 메타센싱 트렌드 — 감정도 MBTI처럼 객관적으로 분석하고 싶음
- **니즈**: "나의 감정 유형을 알고 싶고, 친구들에게 공유하고 싶다"
- **지불 의향**: 무료 사용 위주, 바이럴 기여 가치 높음

### 3-2. 타겟 규모

| 세그먼트 | 규모 | 근거 |
|---------|------|------|
| MZ세대 감정 관리 관심층 | ~800만 명 | 20~35세 인구 1,200만 × 자기관리 앱 이용률 65% |
| 감정 관리 앱 사용 경험자 | ~500만 명 | 하루콩 200만 + 마인드카페 400만 + 기타 (중복 제거) |
| AI 심리상담 이용 의향자 | ~480만 명 | 관심층 800만 × 이용 의향 40% (한국리서치 2025) |
| 핵심 타겟 (기록+분석+행동) | ~300만 명 | "기록은 하고 싶지만 상담까지는 부담" 중간층 |

---

## 4. User Stories

### Epic 1: 온보딩 & 인증

| ID | As a | I want to | So that |
|----|------|-----------|---------|
| US-01 | 신규 사용자 | 카카오/Apple/이메일 중 하나로 간편하게 가입하고 싶다 | 별도 인증 과정 없이 빠르게 앱을 시작할 수 있다 |
| US-02 | 신규 사용자 | 온보딩에서 마음날씨의 감정 체계를 이해하고 첫 감정을 기록하고 싶다 | 앱의 핵심 가치를 체험한 후 사용을 결정할 수 있다 |
| US-03 | 신규 사용자 | 온보딩에서 기록 알림 시간을 설정하고 싶다 | 매일 잊지 않고 감정을 기록하는 습관을 만들 수 있다 |

### Epic 2: 감정 기록

| ID | As a | I want to | So that |
|----|------|-----------|---------|
| US-04 | 사용자 | 10초 이내에 오늘의 감정을 기록하고 싶다 | 매일 부담 없이 기록 습관을 유지할 수 있다 |
| US-05 | 사용자 | 한국어로 된 감정 어휘(서운함, 답답함, 뿌듯함 등)로 감정을 선택하고 싶다 | 내 감정을 더 정확하게 표현할 수 있다 |
| US-06 | 사용자 | 감정과 함께 활동 태그(출근, 회의, 운동 등)를 연결하고 싶다 | 어떤 활동이 감정에 영향을 주는지 파악할 수 있다 |
| US-07 | 사용자 | 오프라인 상태에서도 감정을 기록하고 싶다 | 지하철이나 네트워크 없는 환경에서도 기록을 놓치지 않는다 |
| US-08 | 사용자 | 기록한 감정을 수정하거나 삭제하고 싶다 | 잘못 기록한 내용을 바로잡을 수 있다 |

### Epic 3: 감정 캘린더 & 통계

| ID | As a | I want to | So that |
|----|------|-----------|---------|
| US-09 | 사용자 | 월별 캘린더에서 날짜별 주요 감정을 한눈에 보고 싶다 | 한 달간 감정 흐름을 시각적으로 파악할 수 있다 |
| US-10 | 사용자 | 주간 감정 요약 리포트를 받고 싶다 | 한 주간 내 감정 흐름을 한눈에 파악할 수 있다 |
| US-11 | 사용자 | 특정 날짜를 탭하여 해당일 기록 리스트를 보고 싶다 | 그날 어떤 감정을 느꼈는지 상세히 되돌아볼 수 있다 |

### Epic 4: 셀프케어 행동 제안

| ID | As a | I want to | So that |
|----|------|-----------|---------|
| US-12 | 사용자 | 현재 감정에 맞는 셀프케어 행동을 추천받고 싶다 | "답답할 때 뭘 하면 좋은지" 바로 실행할 수 있다 |
| US-13 | 사용자 | 셀프케어 행동에 대해 "도움됨/아님" 피드백을 남기고 싶다 | 나에게 맞는 행동이 점점 더 정확하게 추천된다 |

### Epic 5: 프리미엄 리포트 & 분석

| ID | As a | I want to | So that |
|----|------|-----------|---------|
| US-14 | 유료 사용자 | 감정-활동-시간 상관관계 분석을 보고 싶다 | "화요일 오후에 답답함이 반복된다"를 알 수 있다 |
| US-15 | 유료 사용자 | 월간 감정 추이와 인사이트를 받고 싶다 | 장기적인 감정 변화를 이해하고 개선할 수 있다 |
| US-16 | 유료 사용자 | 감정 분석 리포트를 PDF로 내보내고 싶다 | 기록을 보관하거나 상담사에게 공유할 수 있다 |

### Epic 6: 설정 & 프로필

| ID | As a | I want to | So that |
|----|------|-----------|---------|
| US-17 | 사용자 | 기록 알림 시간을 변경하고 싶다 | 나의 생활 패턴에 맞게 알림을 조정할 수 있다 |
| US-18 | 사용자 | 앱 잠금(생체인식/PIN)을 설정하고 싶다 | 개인적인 감정 기록을 안전하게 보호할 수 있다 |
| US-19 | 사용자 | 내 계정을 삭제하고 모든 데이터를 영구 삭제하고 싶다 | 더 이상 사용하지 않을 때 개인정보를 완전히 제거할 수 있다 |

### Epic 7: 구독 & 결제

| ID | As a | I want to | So that |
|----|------|-----------|---------|
| US-20 | 사용자 | 프리미엄 7일 무료 체험을 시작하고 싶다 | 결제 전에 유료 기능의 가치를 확인할 수 있다 |
| US-21 | 사용자 | 월간 또는 연간 구독을 선택하여 결제하고 싶다 | 나에게 맞는 결제 방식으로 프리미엄 기능을 이용할 수 있다 |
| US-22 | 유료 사용자 | 구독을 취소하거나 플랜을 변경하고 싶다 | 필요에 따라 구독을 유연하게 관리할 수 있다 |

### Epic 8: 알림

| ID | As a | I want to | So that |
|----|------|-----------|---------|
| US-23 | 사용자 | 설정한 시간에 감정 기록 리마인더를 받고 싶다 | 기록을 빠뜨리지 않고 매일 습관을 유지할 수 있다 |
| US-24 | 사용자 | 주간 리포트가 준비되면 알림을 받고 싶다 | 리포트를 즉시 확인하고 한 주를 돌아볼 수 있다 |

**User Stories 요약**: 8개 Epic, 24개 Story. 온보딩(3), 감정 기록(5), 캘린더/통계(3), 셀프케어(2), 프리미엄(3), 설정(3), 결제(3), 알림(2) — 모든 기능 영역을 커버.

---

## 5. Functional Requirements

### 5-1. MVP 핵심 기능 (P0 — 필수)

#### F-01: 감정 태깅 (10초 기록)

| 항목 | 명세 |
|------|------|
| **감정 어휘** | 한국어 특화 감정 36종 (대분류 7종 → 소분류 36종) |
| **감정 분류 체계** | 대분류 7종 (기쁨, 기대/설렘, 평온, 슬픔, 분노, 불안, 무기력) → 소분류 36종 |
| **입력 방식** | 터치로 감정 태그 1~3개 선택 |
| **활동 태그** | 기본 20종 + 사용자 커스텀 |
| **메모** | 선택적 한줄 메모 (최대 200자) |
| **시간** | 기록 시점 자동 저장 + 수동 시간 변경 가능 |
| **빈도** | 하루 무제한 기록 가능 |
| **무료/유료** | 무료 이용 가능 |

**수용 기준:**
- AC-01-1: 감정 태그 1~3개 선택 후 저장 시 1초 이내 응답
- AC-01-2: 활동 태그 0~N개 선택 가능, 커스텀 태그 추가 가능
- AC-01-3: 메모 200자 초과 시 입력 차단 및 잔여 글자 수 표시
- AC-01-4: recorded_at 기본값은 현재 시각, 수동 변경 가능
- AC-01-5: 오프라인 상태에서 저장 시 로컬 저장 후 "(오프라인 저장됨)" 표시, 네트워크 복구 시 자동 동기화

#### F-02: 감정 캘린더 & 기본 통계

| 항목 | 명세 |
|------|------|
| **캘린더 뷰** | 월별 캘린더에 일별 주요 감정 표시 (색상/아이콘) |
| **주간 요약** | 이번 주 감정 빈도 Top 3, 긍정/부정 비율, 활동 태그 Top 3 |
| **감정 히스토리** | 일별 감정 기록 리스트 (타임라인 뷰) |
| **무료/유료** | 무료 이용 가능 (기본 주간 요약) |

**수용 기준:**
- AC-02-1: 캘린더에서 날짜별 주요 감정 아이콘/색상 표시, 월 단위 이동 가능
- AC-02-2: 주간 요약에 감정 빈도 Top 3, 긍정/부정 비율, 활동 Top 3 포함
- AC-02-3: 특정 날짜 탭 시 해당일 기록 리스트 표시 (시간순 정렬)

#### F-03: 셀프케어 행동 카드

| 항목 | 명세 |
|------|------|
| **카드 구성** | 감정별 3~5개 행동 제안 (100개+ 행동 카드) |
| **매핑 방식** | 규칙 기반 (감정 태그 → 행동 카드 매핑 테이블) |
| **무료 제한** | 일 3개 카드 |
| **피드백** | "도움됨" / "도움 안 됨" 버튼 → 개인화 점수 축적 |
| **무료/유료** | 무료 3개/일, 유료 무제한 |

**수용 기준:**
- AC-03-1: 감정 기록 저장 후 해당 감정에 매핑된 셀프케어 카드 즉시 표시
- AC-03-2: 무료 사용자는 일 3개 카드로 제한, 프리미엄은 무제한 표시
- AC-03-3: 피드백 버튼 탭 시 피드백 즉시 저장, 이후 추천 시 피드백 반영 정렬 (도움됨 상위)

#### F-04: 사용자 인증 & 프로필

| 항목 | 명세 |
|------|------|
| **인증 방식** | 카카오 로그인, Apple 로그인, 이메일/비밀번호 |
| **프로필** | 닉네임(필수), 연령대(선택), 알림 시간 설정 |
| **온보딩** | 3스텝: 감정 체계 안내 → 첫 감정 기록 체험 → 알림 시간 설정 |
| **무료/유료** | 무료 이용 가능 |

**수용 기준:**
- AC-04-1: 카카오/Apple/이메일 중 하나로 회원가입 및 로그인 가능
- AC-04-2: 프로필에 닉네임(필수, 2~12자), 연령대(선택), 알림시간(기본 21:00) 저장
- AC-04-3: 온보딩 3스텝 완료 후 onboarding_completed = true 설정
- AC-04-4: 온보딩 스킵 가능, 이후 설정에서 알림 시간 변경 가능

#### F-05: 푸시 알림

| 항목 | 명세 |
|------|------|
| **기록 리마인더** | 사용자가 설정한 시간에 기록 알림 (기본: 오후 9시) |
| **주간 리포트** | 매주 월요일 오전, 지난 주 감정 요약 알림 |
| **기술** | Expo Push Notifications |
| **무료/유료** | 무료 이용 가능 |

**수용 기준:**
- AC-05-1: 설정한 시간에 푸시 알림 수신, 알림 탭 시 기록 화면으로 이동
- AC-05-2: 주간 리포트 생성 완료 시 푸시 알림 발송
- AC-05-3: 알림 비활성화 시 푸시 발송 중지

### 5-2. 유료 기능 (P0 — 필수, 수익화)

#### F-06: AI 감정 패턴 리포트 (프리미엄)

| 항목 | 명세 |
|------|------|
| **주간 리포트** | 감정-시간대-요일 분석, 가장 빈번한 감정 패턴, 핵심 인사이트 문구 |
| **월간 리포트** | 월별 감정 추이, 긍정/부정 비율 변화, 활동-감정 상관관계 Top 5 |
| **인사이트 예시** | "화요일 오후에 '답답함'이 집중됩니다", "운동한 날은 긍정 감정이 2배 높습니다" |
| **구현 방식** | PostgreSQL 집계 함수 + Edge Functions (AI/ML 불필요) |
| **무료/유료** | 프리미엄 전용 |

**수용 기준:**
- AC-06-1: 프리미엄 사용자에게만 상세 리포트 반환, 무료 사용자 요청 시 구독 유도 화면 표시
- AC-06-2: 주간 리포트에 요일별/시간대별 감정 패턴, 인사이트 문구 1~3개 포함
- AC-06-3: 월간 리포트에 감정 추이 그래프 데이터, 활동-감정 상관관계 Top 5 포함
- AC-06-4: 기록이 7건 미만인 주간에는 "데이터 부족" 안내 표시

#### F-07: 무제한 셀프케어 카드 (프리미엄)

| 항목 | 명세 |
|------|------|
| **무제한 카드** | 무료 3개/일 제한 해제 |
| **개인화 랭킹** | 피드백 데이터 기반 "나에게 효과적이었던 행동" 우선 표시 |
| **무료/유료** | 프리미엄 전용 |

**수용 기준:**
- AC-07-1: 프리미엄 사용자에게 카드 수 제한 없이 전체 반환, 개인화 점수 순 정렬

#### F-08: 데이터 내보내기 (프리미엄)

| 항목 | 명세 |
|------|------|
| **PDF 리포트** | 월간/분기별 감정 분석 리포트 PDF 생성 |
| **CSV 내보내기** | 전체 감정 기록 데이터 CSV 다운로드 |
| **PDF 기술** | Edge Function에서 `pdf-lib` 라이브러리로 생성 → Storage 업로드 → 서명된 URL 반환 |
| **무료/유료** | 프리미엄 전용 |

**수용 기준:**
- AC-08-1: PDF 생성 시 월간/분기 감정 분석(감정 빈도, 추이, 활동 상관관계) 포함
- AC-08-2: CSV에 전체 감정 기록(날짜, 시간, 감정, 활동, 메모) 포함, UTF-8 BOM 인코딩

### 5-3. 구독 & 결제 (P0 — 필수)

#### F-09: 인앱 결제

| 항목 | 명세 |
|------|------|
| **구독 플랜** | 월간 3,500원 / 연간 27,900원 (33% 할인) |
| **무료 체험** | 프리미엄 7일 무료 체험 (가입 후 1회) |
| **결제 수단** | Apple IAP, Google Play Billing |
| **기술** | RevenueCat SDK 연동 |

**수용 기준:**
- AC-09-1: 구독 구매 완료 후 is_premium 즉시 반영, 프리미엄 기능 즉시 활성화
- AC-09-2: 구독 만료 시 프리미엄 기능 차단, 기존 데이터는 유지
- AC-09-3: 7일 무료 체험 종료 후 자동 결제, 체험 중 취소 시 과금 없음

### 5-4. 바이럴 기능 (P1 — 출시 후 우선)

#### F-10: 감정 리포트 공유 카드

| 항목 | 명세 |
|------|------|
| **공유 카드** | "이번 주 나의 감정 리포트" 카드 이미지 생성 |
| **디자인** | 날씨 메타포 기반 (맑음, 구름, 비, 폭풍 등) |
| **공유 채널** | 카카오톡, 인스타그램 스토리, 이미지 저장 |
| **기술** | 클라이언트 사이드 `react-native-view-shot`으로 UI → 이미지 캡처 |

### 5-5. 향후 확장 기능 (P2 — MVP 이후)

| ID | 기능 | 설명 | 예상 시기 |
|----|------|------|----------|
| F-11 | LLM 개인화 인사이트 | OpenAI API로 인사이트 문구 개인화 생성 | MVP+2개월 |
| F-12 | 예측적 알림 | "내일 월요일, 지난 4주간 월요일 아침 스트레스가 높았습니다" | MVP+3개월 |
| F-13 | 감정 유형 분석 | MBTI처럼 "나의 감정 유형" 분류 → 공유 가능 | MVP+2개월 |
| F-14 | 위젯 | 홈 화면 감정 기록 위젯 | MVP+1개월 |
| F-15 | 상담 연결 | 전문 상담이 필요한 경우 외부 서비스 연결 | MVP+6개월 |

---

## 6. Non-Functional Requirements

### 6-1. 성능

| 항목 | 기준 |
|------|------|
| 앱 실행 시간 | 콜드 스타트 2초 이내 |
| 감정 기록 저장 | 1초 이내 응답 (오프라인 시 로컬 즉시 저장) |
| 리포트 생성 | 3초 이내 (캐싱 적용) |
| API 응답 시간 | 500ms 이내 (95 percentile) |

### 6-2. 보안 & 개인정보

| 항목 | 기준 |
|------|------|
| 데이터 전송 | HTTPS (TLS 1.3) |
| 데이터 저장 | Supabase RLS (Row Level Security)로 사용자별 격리 |
| 인증 | Supabase Auth (JWT 토큰) |
| 개인정보 처리 | 개인정보 처리방침 고지, 최소한의 개인정보 수집 |
| 데이터 삭제 | 계정 삭제 시 모든 데이터 영구 삭제 (30일 유예) |
| 앱 잠금 | 생체인식 / PIN 잠금 지원 |

### 6-3. 접근성

| 항목 | 기준 |
|------|------|
| 최소 OS | iOS 15+, Android 10+ |
| 다크 모드 | 지원 |
| 폰트 크기 | 시스템 설정 연동 |
| VoiceOver/TalkBack | 주요 화면 접근성 레이블 |

### 6-4. 확장성

| 항목 | 기준 |
|------|------|
| 동시 사용자 | Supabase Free Tier → Pro 전환 시 10만+ 지원 |
| 데이터 증가 | 인덱스 최적화 + 소프트 삭제 기반 설계 |
| API Rate Limit | 사용자당 100 req/min |

---

## 7. Technical Architecture

> **작성 방법**: `sc:design` 스킬을 통해 Functional Requirements(P0/P1), Non-functional Requirements, 기술 설계 제약을 입력으로 설계하였다.

### 7-1. 기술 스택

| 계층 | 기술 | 선택 이유 |
|------|------|----------|
| **프론트엔드** | React Native + TypeScript + Expo | 크로스 플랫폼, 1인 개발 효율, OTA 업데이트 |
| **UI 프레임워크** | React Native Paper / NativeWind | Material Design 준수, 빠른 개발 |
| **상태 관리** | Zustand + TanStack Query | 경량 전역 상태 + 서버 상태 캐싱/동기화 |
| **로컬 저장소** | WatermelonDB (구조화 데이터) + MMKV (KV) | 오프라인 우선, Observable 지원, 초고속 KV |
| **차트/그래프** | Victory Native | 감정 통계 시각화 |
| **캘린더** | react-native-calendars | 감정 캘린더 뷰 |
| **백엔드** | Supabase (PostgreSQL + Auth + Edge Functions + Storage) | BaaS, 1인 개발에 최적, RLS 내장 |
| **결제** | RevenueCat | 크로스 플랫폼 IAP 통합 관리 |
| **푸시 알림** | Expo Push Notifications | Expo 생태계 연동 |
| **빌드/배포** | Expo Application Services (EAS) | OTA 업데이트, 빌드 자동화 |
| **분석** | PostHog | 사용자 행동 분석, 퍼널 분석 |
| **크래시 리포트** | Sentry | 에러 모니터링 |

### 7-2. 시스템 구조도

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Client (React Native + Expo)                     │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                        UI Layer (Screens)                       │   │
│  │  ┌────────┐ ┌──────────┐ ┌──────────┐ ┌────────┐ ┌─────────┐ │   │
│  │  │ 감정   │ │ 캘린더/  │ │ 셀프케어 │ │ 리포트 │ │ 설정/   │ │   │
│  │  │ 기록   │ │ 히스토리 │ │ 카드     │ │        │ │ 프로필  │ │   │
│  │  └───┬────┘ └────┬─────┘ └────┬─────┘ └───┬────┘ └────┬────┘ │   │
│  └──────┼───────────┼────────────┼────────────┼───────────┼──────┘   │
│         └───────────┴────────────┴────────────┴───────────┘          │
│                                  │                                    │
│  ┌───────────────────────────────┴──────────────────────────────┐    │
│  │              State Management (Zustand + TanStack Query)      │    │
│  │   ┌────────────────┐  ┌──────────────┐  ┌────────────────┐  │    │
│  │   │ Auth Store      │  │ Emotion      │  │ Subscription   │  │    │
│  │   │ (인증 상태)     │  │ Record Store │  │ Store          │  │    │
│  │   └────────────────┘  └──────────────┘  └────────────────┘  │    │
│  └───────────────────────────────┬──────────────────────────────┘    │
│                                  │                                    │
│  ┌───────────────────────────────┴──────────────────────────────┐    │
│  │              Offline-First Layer (오프라인 우선 계층)           │    │
│  │   ┌──────────────┐  ┌──────────────┐  ┌───────────────────┐  │    │
│  │   │ WatermelonDB │  │ MMKV         │  │ Sync Queue       │  │    │
│  │   │ (감정 기록,  │  │ (설정, 캐시, │  │ (오프라인 기록   │  │    │
│  │   │  피드백 등   │  │  토큰, 구독  │  │  대기열 관리)    │  │    │
│  │   │  구조화 데이터)│  │  상태 등 KV) │  │                  │  │    │
│  │   └──────────────┘  └──────────────┘  └───────────────────┘  │    │
│  └──────────────────────────────────────────────────────────────┘    │
│                                  │                                    │
│  ┌───────────────────────────────┴──────────────────────────────┐    │
│  │              Network Layer (네트워크 계층)                     │    │
│  │   ┌──────────────────┐  ┌──────────────────────────────┐    │    │
│  │   │ Supabase JS SDK  │  │ RevenueCat SDK               │    │    │
│  │   │ (Auth, REST,     │  │ (인앱결제, 구독 상태)         │    │    │
│  │   │  Edge Functions) │  │                               │    │    │
│  │   └────────┬─────────┘  └──────────────┬───────────────┘    │    │
│  └────────────┼────────────────────────────┼───────────────────┘    │
└───────────────┼────────────────────────────┼────────────────────────┘
                │ HTTPS (TLS 1.3)            │ HTTPS
                ▼                            ▼
┌───────────────────────────────────────┐  ┌─────────────────────────┐
│          Supabase Backend             │  │     RevenueCat          │
│                                       │  │  구독 관리 + Webhook    │
│  ┌──────────┐  ┌──────────────────┐  │  └─────────────────────────┘
│  │ Auth     │  │ PostgreSQL       │  │
│  │ 카카오/  │  │ 감정 기록, 사용자│  │  ┌─────────────────────────┐
│  │ Apple/   │  │ 셀프케어, 피드백 │  │  │     Expo Push           │
│  │ Email    │  │ 구독, 리포트 캐시│  │  │  기록 리마인더/리포트   │
│  └──────────┘  └──────────────────┘  │  └─────────────────────────┘
│  ┌──────────┐  ┌──────────────────┐  │
│  │ Storage  │  │ Edge Functions   │  │  ┌─────────────────────────┐
│  │ PDF/이미지│  │ 리포트, 추천,   │  │  │  PostHog + Sentry       │
│  └──────────┘  │ PDF/CSV, 구독   │  │  │  분석 + 에러 모니터링   │
│                │ 검증, 푸시 발송  │  │  └─────────────────────────┘
│  ┌──────────┐  └──────────────────┘  │
│  │ RLS      │  ┌──────────────────┐  │
│  │ 사용자별 │  │ pg_cron          │  │
│  │ 데이터격리│  │ 스케줄 작업      │  │
│  └──────────┘  └──────────────────┘  │
└───────────────────────────────────────┘
```

### 7-3. 오프라인 우선 설계

```
[사용자: 감정 기록 저장]
    │
    ▼
┌──────────────────┐
│ WatermelonDB     │ ← 1. 즉시 로컬 저장 (0~50ms)
│ sync_status =    │    client_created_at = 현재시간
│ 'pending'        │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ UI 즉시 반영     │ ← 2. 낙관적 업데이트 (Optimistic UI)
│ "저장 완료"      │    오프라인 시 "(오프라인 저장됨)" 표시
└────────┬─────────┘
         │
         ▼
┌──────────────────┐     ┌──────────────────────┐
│ Sync Queue       │────→│ 네트워크 상태 감지    │
│ (동기화 대기열)   │     │ (NetInfo API)        │
│ 최대 3회 재시도   │     │                      │
│ 지수 백오프       │     │ 온라인 → 즉시 동기화 │
│ (1s→2s→4s)       │     │ 오프라인 → 대기      │
└──────────────────┘     │ 복구 시 → 배치 동기화│
                         └──────────┬───────────┘
                                    │
                                    ▼
                         ┌──────────────────────┐
                         │ Supabase 서버 동기화  │
                         │                      │
                         │ Push: 로컬 → 서버    │
                         │ Pull: 서버 → 로컬    │
                         │                      │
                         │ 충돌 해결:           │
                         │ Server Wins 원칙     │
                         │ 단, 미동기화 로컬    │
                         │ 레코드는 항상 보존   │
                         └──────────────────────┘
```

**저장소 역할 분담:**
- **WatermelonDB (SQLite 기반)**: `emotion_records`, `emotion_record_emotions`, `emotion_record_activities`, `selfcare_feedback`, `daily_card_usage` — 관계형 쿼리, 동기화 내장, Observable 지원
- **MMKV (Key-Value)**: JWT 토큰, 사용자 설정, 구독 상태 캐시, 마스터 데이터 버전, 마지막 동기화 시점, 앱 잠금 설정 — 초고속 읽기/쓰기, 동기식 접근

**충돌 해결 원칙**: "사용자의 감정 기록은 절대 유실하지 않는다"
- CREATE: UUID 기반이므로 충돌 없음, 서버에 INSERT
- UPDATE: `server_updated_at` vs `client_updated_at` 비교, 서버 타임스탬프 우선
- DELETE: 소프트 삭제 (`deleted_at`) 사용, 양측 삭제 상태 병합

### 7-4. 핵심 설계 원칙

1. **오프라인 우선**: 감정 기록은 WatermelonDB에 즉시 저장 → 네트워크 복구 시 동기화
2. **최소 외부 의존**: MVP에서 AI/ML 모델 불필요, SQL 집계로 패턴 분석
3. **점진적 복잡성**: 규칙 기반 → 통계 기반 → (향후) LLM 기반으로 단계적 고도화
4. **RLS 기반 보안**: 모든 테이블에 Row Level Security 적용
5. **낙관적 UI**: 저장/수정 시 로컬 상태를 즉시 반영하여 체감 속도 최적화

### 7-5. DB 스키마

#### ERD 개요

```
users ──< emotion_records ──< emotion_record_emotions >── emotions ──< emotion_categories
  │            │
  │            └──< emotion_record_activities >── activities
  │
  ├──< push_tokens
  ├──< selfcare_feedback
  ├──< daily_card_usage
  ├──< subscriptions
  └──< report_cache

emotions ──< selfcare_emotion_map >── selfcare_cards
```

#### 테이블 정의

##### `users` (사용자)
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email TEXT UNIQUE,
  nickname TEXT NOT NULL,
  age_group TEXT CHECK (age_group IN ('10s', '20s', '30s', '40s', '50s+')),
  notification_time TIME DEFAULT '21:00',
  notification_enabled BOOLEAN DEFAULT TRUE,
  weekly_report_enabled BOOLEAN DEFAULT TRUE,
  timezone TEXT DEFAULT 'Asia/Seoul',
  is_premium BOOLEAN DEFAULT FALSE,
  premium_expires_at TIMESTAMPTZ,
  onboarding_completed BOOLEAN DEFAULT FALSE,
  app_lock_enabled BOOLEAN DEFAULT FALSE,
  app_lock_type TEXT CHECK (app_lock_type IN ('biometric', 'pin', NULL)),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX idx_users_email ON users(email);
```

##### `emotion_categories` (감정 대분류 — 7종)
```sql
CREATE TABLE emotion_categories (
  id SERIAL PRIMARY KEY,
  name TEXT NOT NULL UNIQUE,
  color TEXT NOT NULL,
  icon TEXT NOT NULL,
  weather_label TEXT NOT NULL,
  valence TEXT NOT NULL CHECK (valence IN ('positive', 'negative', 'neutral')),
  sort_order INT DEFAULT 0
);
```

##### `emotions` (감정 소분류 — 36종)
```sql
CREATE TABLE emotions (
  id SERIAL PRIMARY KEY,
  category_id INT NOT NULL REFERENCES emotion_categories(id),
  name TEXT NOT NULL UNIQUE,
  description TEXT,
  intensity INT DEFAULT 3 CHECK (intensity BETWEEN 1 AND 5),
  color TEXT,
  sort_order INT DEFAULT 0
);
CREATE INDEX idx_emotions_category ON emotions(category_id);
```

##### `activities` (활동 태그)
```sql
CREATE TABLE activities (
  id SERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  icon TEXT NOT NULL,
  is_default BOOLEAN DEFAULT TRUE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  sort_order INT DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT activity_default_check CHECK (
    (is_default = TRUE AND user_id IS NULL) OR
    (is_default = FALSE AND user_id IS NOT NULL)
  )
);
CREATE INDEX idx_activities_user ON activities(user_id) WHERE user_id IS NOT NULL;
```

##### `emotion_records` (감정 기록 — 핵심 테이블)
```sql
CREATE TABLE emotion_records (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  memo TEXT,
  recorded_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  client_created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  sync_status TEXT DEFAULT 'synced' CHECK (sync_status IN ('synced', 'pending', 'conflict')),
  deleted_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT memo_max_length CHECK (char_length(memo) <= 200)
);
CREATE INDEX idx_emotion_records_user_date ON emotion_records(user_id, recorded_at DESC) WHERE deleted_at IS NULL;
CREATE INDEX idx_emotion_records_user_period ON emotion_records(user_id, recorded_at) WHERE deleted_at IS NULL;
```

##### `emotion_record_emotions` (기록-감정 연결, M:N)
```sql
CREATE TABLE emotion_record_emotions (
  record_id UUID NOT NULL REFERENCES emotion_records(id) ON DELETE CASCADE,
  emotion_id INT NOT NULL REFERENCES emotions(id),
  PRIMARY KEY (record_id, emotion_id)
);
CREATE INDEX idx_ere_emotion ON emotion_record_emotions(emotion_id);
```

##### `emotion_record_activities` (기록-활동 연결, M:N)
```sql
CREATE TABLE emotion_record_activities (
  record_id UUID NOT NULL REFERENCES emotion_records(id) ON DELETE CASCADE,
  activity_id INT NOT NULL REFERENCES activities(id),
  PRIMARY KEY (record_id, activity_id)
);
CREATE INDEX idx_era_activity ON emotion_record_activities(activity_id);
```

##### `selfcare_cards` (셀프케어 행동 카드 — 100개+)
```sql
CREATE TABLE selfcare_cards (
  id SERIAL PRIMARY KEY,
  title TEXT NOT NULL,
  description TEXT NOT NULL,
  duration_minutes INT,
  category TEXT NOT NULL CHECK (category IN (
    'breathing', 'movement', 'sensory', 'social', 'creative'
  )),
  icon TEXT NOT NULL,
  is_active BOOLEAN DEFAULT TRUE,
  sort_order INT DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX idx_selfcare_cards_category ON selfcare_cards(category) WHERE is_active = TRUE;
```

##### `selfcare_emotion_map` (감정-셀프케어 매핑)
```sql
CREATE TABLE selfcare_emotion_map (
  emotion_id INT NOT NULL REFERENCES emotions(id),
  card_id INT NOT NULL REFERENCES selfcare_cards(id),
  relevance_score FLOAT DEFAULT 1.0 CHECK (relevance_score BETWEEN 0.0 AND 1.0),
  PRIMARY KEY (emotion_id, card_id)
);
```

##### `selfcare_feedback` (셀프케어 피드백)
```sql
CREATE TABLE selfcare_feedback (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  card_id INT NOT NULL REFERENCES selfcare_cards(id),
  emotion_id INT NOT NULL REFERENCES emotions(id),
  record_id UUID REFERENCES emotion_records(id) ON DELETE SET NULL,
  is_helpful BOOLEAN NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX idx_selfcare_feedback_personalization ON selfcare_feedback(user_id, card_id, emotion_id);
CREATE INDEX idx_selfcare_feedback_user ON selfcare_feedback(user_id, created_at DESC);
```

##### `subscriptions` (구독 정보)
```sql
CREATE TABLE subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  plan_type TEXT NOT NULL CHECK (plan_type IN ('monthly', 'yearly')),
  status TEXT NOT NULL DEFAULT 'active' CHECK (status IN (
    'active', 'trialing', 'cancelled', 'expired', 'grace_period'
  )),
  revenue_cat_id TEXT UNIQUE,
  original_purchase_date TIMESTAMPTZ,
  started_at TIMESTAMPTZ NOT NULL,
  expires_at TIMESTAMPTZ NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX idx_subscriptions_user_status ON subscriptions(user_id, status);
CREATE INDEX idx_subscriptions_expiry ON subscriptions(expires_at) WHERE status IN ('active', 'trialing', 'grace_period');
```

##### `push_tokens` (푸시 알림 토큰)
```sql
CREATE TABLE push_tokens (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  token TEXT NOT NULL UNIQUE,
  platform TEXT NOT NULL CHECK (platform IN ('ios', 'android')),
  device_id TEXT,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX idx_push_tokens_user ON push_tokens(user_id) WHERE is_active = TRUE;
```

##### `daily_card_usage` (일일 셀프케어 카드 사용량 추적)
```sql
CREATE TABLE daily_card_usage (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  usage_date DATE NOT NULL DEFAULT CURRENT_DATE,
  card_count INT NOT NULL DEFAULT 0,
  last_card_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT unique_user_date UNIQUE (user_id, usage_date),
  CONSTRAINT card_count_positive CHECK (card_count >= 0)
);
```

##### `report_cache` (리포트 캐시)
```sql
CREATE TABLE report_cache (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  report_type TEXT NOT NULL CHECK (report_type IN ('weekly', 'monthly')),
  period_start DATE NOT NULL,
  period_end DATE NOT NULL,
  report_data JSONB NOT NULL,
  generated_at TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT unique_user_report_period UNIQUE (user_id, report_type, period_start)
);
CREATE INDEX idx_report_cache_user ON report_cache(user_id, report_type, period_start DESC);
```

#### RLS 정책 요약

| 테이블 | SELECT | INSERT | UPDATE | DELETE |
|--------|--------|--------|--------|--------|
| `users` | 본인만 | Auth 자동 | 본인만 | Edge Function |
| `emotion_categories` | 인증 사용자 전체 | - | - | - |
| `emotions` | 인증 사용자 전체 | - | - | - |
| `activities` | 기본 전체 + 본인 커스텀 | 본인 커스텀만 | 본인 커스텀만 | 본인 커스텀만 |
| `emotion_records` | 본인만 | 본인만 | 본인만 | 본인만 |
| `emotion_record_emotions` | 부모 레코드 소유자 | 부모 레코드 소유자 | - | CASCADE |
| `emotion_record_activities` | 부모 레코드 소유자 | 부모 레코드 소유자 | - | CASCADE |
| `selfcare_cards` | 인증 사용자 전체 | - | - | - |
| `selfcare_emotion_map` | 인증 사용자 전체 | - | - | - |
| `selfcare_feedback` | 본인만 | 본인만 | - | - |
| `subscriptions` | 본인만 | Edge Function | Edge Function | - |
| `push_tokens` | 본인만 | 본인만 | 본인만 | 본인만 |
| `daily_card_usage` | 본인만 | 본인만 | 본인만 | - |
| `report_cache` | 본인만 | Edge Function | Edge Function | - |

#### 핵심 DB Functions (RPC) — 완전한 SQL 본문

##### `create_emotion_record` — 감정 기록 트랜잭션 생성
```sql
CREATE OR REPLACE FUNCTION create_emotion_record(
  p_memo TEXT DEFAULT NULL,
  p_recorded_at TIMESTAMPTZ DEFAULT NOW(),
  p_emotion_ids INT[] DEFAULT '{}',
  p_activity_ids INT[] DEFAULT '{}'
)
RETURNS UUID
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  v_user_id UUID;
  v_record_id UUID;
  v_emotion_id INT;
  v_activity_id INT;
BEGIN
  -- 현재 인증 사용자 확인
  v_user_id := auth.uid();
  IF v_user_id IS NULL THEN
    RAISE EXCEPTION 'Not authenticated';
  END IF;

  -- 감정 태그 1~3개 검증
  IF array_length(p_emotion_ids, 1) IS NULL
     OR array_length(p_emotion_ids, 1) < 1
     OR array_length(p_emotion_ids, 1) > 3 THEN
    RAISE EXCEPTION 'emotion_ids must contain 1 to 3 elements';
  END IF;

  -- 메모 길이 검증
  IF p_memo IS NOT NULL AND char_length(p_memo) > 200 THEN
    RAISE EXCEPTION 'memo must be 200 characters or less';
  END IF;

  -- 1. emotion_records INSERT
  INSERT INTO emotion_records (user_id, memo, recorded_at, client_created_at, sync_status)
  VALUES (v_user_id, p_memo, p_recorded_at, NOW(), 'synced')
  RETURNING id INTO v_record_id;

  -- 2. emotion_record_emotions INSERT (배열 순회)
  FOREACH v_emotion_id IN ARRAY p_emotion_ids
  LOOP
    INSERT INTO emotion_record_emotions (record_id, emotion_id)
    VALUES (v_record_id, v_emotion_id);
  END LOOP;

  -- 3. emotion_record_activities INSERT (배열 순회, 빈 배열 허용)
  IF p_activity_ids IS NOT NULL AND array_length(p_activity_ids, 1) > 0 THEN
    FOREACH v_activity_id IN ARRAY p_activity_ids
    LOOP
      INSERT INTO emotion_record_activities (record_id, activity_id)
      VALUES (v_record_id, v_activity_id);
    END LOOP;
  END IF;

  RETURN v_record_id;
END;
$$;
```

##### `get_weekly_summary` — 주간 기본 요약 (무료)
```sql
CREATE OR REPLACE FUNCTION get_weekly_summary(
  p_start_date DATE,
  p_end_date DATE
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  v_user_id UUID;
  v_total_records INT;
  v_recording_days INT;
  v_top_emotions JSONB;
  v_positive_ratio NUMERIC;
  v_negative_ratio NUMERIC;
  v_top_activities JSONB;
  v_result JSONB;
BEGIN
  v_user_id := auth.uid();
  IF v_user_id IS NULL THEN
    RAISE EXCEPTION 'Not authenticated';
  END IF;

  -- 총 기록 수
  SELECT COUNT(*) INTO v_total_records
  FROM emotion_records
  WHERE user_id = v_user_id
    AND recorded_at >= p_start_date::TIMESTAMPTZ
    AND recorded_at < (p_end_date + 1)::TIMESTAMPTZ
    AND deleted_at IS NULL;

  -- 기록한 날 수
  SELECT COUNT(DISTINCT recorded_at::DATE) INTO v_recording_days
  FROM emotion_records
  WHERE user_id = v_user_id
    AND recorded_at >= p_start_date::TIMESTAMPTZ
    AND recorded_at < (p_end_date + 1)::TIMESTAMPTZ
    AND deleted_at IS NULL;

  -- 감정 빈도 Top 5
  SELECT COALESCE(jsonb_agg(row_to_json(t)::JSONB), '[]'::JSONB) INTO v_top_emotions
  FROM (
    SELECT e.id AS emotion_id, e.name, ec.name AS category_name, COUNT(*) AS count
    FROM emotion_record_emotions ere
    JOIN emotion_records er ON er.id = ere.record_id
    JOIN emotions e ON e.id = ere.emotion_id
    JOIN emotion_categories ec ON ec.id = e.category_id
    WHERE er.user_id = v_user_id
      AND er.recorded_at >= p_start_date::TIMESTAMPTZ
      AND er.recorded_at < (p_end_date + 1)::TIMESTAMPTZ
      AND er.deleted_at IS NULL
    GROUP BY e.id, e.name, ec.name
    ORDER BY count DESC
    LIMIT 5
  ) t;

  -- 긍정/부정 비율
  SELECT
    COALESCE(
      ROUND(
        COUNT(*) FILTER (WHERE ec.valence = 'positive')::NUMERIC
        / NULLIF(COUNT(*), 0) * 100, 1
      ), 0
    ),
    COALESCE(
      ROUND(
        COUNT(*) FILTER (WHERE ec.valence = 'negative')::NUMERIC
        / NULLIF(COUNT(*), 0) * 100, 1
      ), 0
    )
  INTO v_positive_ratio, v_negative_ratio
  FROM emotion_record_emotions ere
  JOIN emotion_records er ON er.id = ere.record_id
  JOIN emotions e ON e.id = ere.emotion_id
  JOIN emotion_categories ec ON ec.id = e.category_id
  WHERE er.user_id = v_user_id
    AND er.recorded_at >= p_start_date::TIMESTAMPTZ
    AND er.recorded_at < (p_end_date + 1)::TIMESTAMPTZ
    AND er.deleted_at IS NULL;

  -- 활동 빈도 Top 3
  SELECT COALESCE(jsonb_agg(row_to_json(t)::JSONB), '[]'::JSONB) INTO v_top_activities
  FROM (
    SELECT a.id AS activity_id, a.name, COUNT(*) AS count
    FROM emotion_record_activities era
    JOIN emotion_records er ON er.id = era.record_id
    JOIN activities a ON a.id = era.activity_id
    WHERE er.user_id = v_user_id
      AND er.recorded_at >= p_start_date::TIMESTAMPTZ
      AND er.recorded_at < (p_end_date + 1)::TIMESTAMPTZ
      AND er.deleted_at IS NULL
    GROUP BY a.id, a.name
    ORDER BY count DESC
    LIMIT 3
  ) t;

  -- 결과 조립
  v_result := jsonb_build_object(
    'total_records', v_total_records,
    'recording_days', v_recording_days,
    'top_emotions', v_top_emotions,
    'positive_ratio', v_positive_ratio,
    'negative_ratio', v_negative_ratio,
    'top_activities', v_top_activities
  );

  RETURN v_result;
END;
$$;
```

### 7-6. API 설계

#### Supabase REST vs Edge Function 선택 기준

| 기준 | REST API 사용 | Edge Function 사용 |
|------|-------------|-------------------|
| 단순 CRUD | O | - |
| 트랜잭션 필요 | DB Function (RPC) | - |
| 복합 비즈니스 로직 | - | O |
| 외부 API 호출 | - | O (RevenueCat, Expo Push) |
| 구독 상태 검증 필요 | - | O |
| 파일 생성 (PDF/이미지) | - | O |

#### 전체 엔드포인트

**인증**

| Method | 경로 | 설명 | 구현 |
|--------|------|------|------|
| - | `supabase.auth.signUp()` | 이메일 회원가입 | Supabase Auth SDK |
| - | `supabase.auth.signInWithPassword()` | 이메일 로그인 | Supabase Auth SDK |
| - | `supabase.auth.signInWithOAuth({ provider: 'kakao' })` | 카카오 로그인 | Supabase Auth SDK |
| - | `supabase.auth.signInWithIdToken({ provider: 'apple' })` | Apple 로그인 | Supabase Auth SDK |
| - | `supabase.auth.signOut()` | 로그아웃 | Supabase Auth SDK |
| POST | `/functions/v1/delete-account` | 계정 삭제 (데이터 영구 삭제 + RevenueCat 취소) | Edge Function |

**감정 기록**

| Method | 경로 | 설명 | 구현 |
|--------|------|------|------|
| POST | `/rest/v1/rpc/create_emotion_record` | 감정 기록 생성 | DB Function (RPC) |
| GET | `/rest/v1/emotion_records?select=*,...&recorded_at=gte.{start}&recorded_at=lt.{end}&deleted_at=is.null` | 기간별 기록 조회 | REST API |
| PATCH | `/rest/v1/emotion_records?id=eq.{id}` | 기록 수정 | REST API |
| PATCH | `/rest/v1/emotion_records?id=eq.{id}` + `{deleted_at: now()}` | 기록 삭제 (소프트) | REST API |

**마스터 데이터**

| Method | 경로 | 설명 | 구현 |
|--------|------|------|------|
| GET | `/rest/v1/emotion_categories?select=*,emotions(*)&order=sort_order` | 감정 분류 체계 | REST API |
| GET | `/rest/v1/activities?or=(is_default.eq.true,user_id.eq.{uid})` | 활동 태그 | REST API |
| POST | `/rest/v1/activities` | 커스텀 활동 태그 생성 | REST API |
| GET | `/rest/v1/selfcare_cards?is_active=eq.true` | 셀프케어 카드 목록 | REST API |

**셀프케어**

| Method | 경로 | 설명 | 구현 |
|--------|------|------|------|
| POST | `/functions/v1/recommend-selfcare` | 감정 기반 셀프케어 추천 | Edge Function |
| POST | `/rest/v1/selfcare_feedback` | 피드백 제출 | REST API |

**리포트**

| Method | 경로 | 설명 | 구현 |
|--------|------|------|------|
| GET | `/rest/v1/rpc/get_weekly_summary` | 주간 기본 요약 (무료) | DB Function (RPC) |
| GET | `/functions/v1/weekly-report` | 주간 상세 리포트 (프리미엄) | Edge Function |
| GET | `/functions/v1/monthly-report` | 월간 상세 리포트 (프리미엄) | Edge Function |
| POST | `/functions/v1/share-card` | 공유 카드 이미지 생성 (P1) | Edge Function |

**결제/구독**

| Method | 경로 | 설명 | 구현 |
|--------|------|------|------|
| POST | `/functions/v1/verify-subscription` | 구독 상태 검증 | Edge Function |
| POST | `/functions/v1/webhook/revenuecat` | RevenueCat Webhook | Edge Function |

**내보내기**

| Method | 경로 | 설명 | 구현 |
|--------|------|------|------|
| POST | `/functions/v1/export-pdf` | PDF 리포트 생성 (프리미엄) | Edge Function |
| POST | `/functions/v1/export-csv` | CSV 다운로드 (프리미엄) | Edge Function |

**푸시 알림**

| Method | 경로 | 설명 | 구현 |
|--------|------|------|------|
| POST | `/rest/v1/push_tokens` | 토큰 등록 | REST API |
| DELETE | `/rest/v1/push_tokens?token=eq.{token}` | 토큰 비활성화 | REST API |
| - | pg_cron → Edge Function | 기록 리마인더 (매 정시) | 스케줄 |
| - | pg_cron → Edge Function | 주간 리포트 알림 (월 09:00 KST) | 스케줄 |

**사용자 프로필**

| Method | 경로 | 설명 | 구현 |
|--------|------|------|------|
| GET | `/rest/v1/users?id=eq.{uid}` | 프로필 조회 | REST API |
| PATCH | `/rest/v1/users?id=eq.{uid}` | 프로필 수정 | REST API |
| POST | `/functions/v1/complete-onboarding` | 온보딩 완료 | Edge Function |

#### 핵심 TypeScript 인터페이스

```typescript
// ===== 감정 기록 =====
interface CreateEmotionRecordRequest {
  p_memo?: string;           // 최대 200자
  p_recorded_at?: string;    // ISO 8601
  p_emotion_ids: number[];   // 1~3개
  p_activity_ids?: number[]; // 0~N개
}

interface EmotionRecordWithRelations {
  id: string;
  user_id: string;
  memo: string | null;
  recorded_at: string;
  created_at: string;
  emotions: { id: number; name: string; category: { name: string; color: string; valence: string } }[];
  activities: { id: number; name: string; icon: string }[];
}

// ===== 셀프케어 추천 =====
interface RecommendSelfcareRequest {
  emotion_ids: number[];     // 방금 기록한 감정 ID
  record_id?: string;        // 연관 기록 ID
}

interface RecommendSelfcareResponse {
  cards: {
    id: number;
    title: string;
    description: string;
    duration_minutes: number | null;
    category: string;
    icon: string;
    personal_score: number;      // 0~1
    helpful_rate: number | null; // 피드백 기반
  }[];
  is_premium: boolean;
  daily_usage: {
    used: number;
    limit: number;               // 무료: 3, 유료: -1(무제한)
    remaining: number;
  };
}

// ===== 리포트 =====
interface WeeklyReportResponse {
  period: { start: string; end: string };
  summary: {
    total_records: number;
    recording_days: number;
    top_emotions: { name: string; category: string; count: number; percentage: number }[];
    positive_ratio: number;
    negative_ratio: number;
  };
  patterns: {
    day_of_week: { day: string; dominant_emotion: string; record_count: number }[];
    time_of_day: { period: string; dominant_emotion: string; record_count: number }[];
    activity_correlation: { activity: string; positive_rate: number; record_count: number }[];
  };
  insights: string[];
  comparison: { vs_last_week: { positive_change: number } };
}

interface MonthlyReportResponse {
  period: { start: string; end: string };
  summary: {
    total_records: number;
    recording_days: number;
    avg_records_per_day: number;
    top_emotions: { name: string; category: string; count: number; percentage: number }[];
    positive_ratio: number;
  };
  trends: {
    weekly_positive_ratios: { week_start: string; ratio: number }[];
    emotion_frequency_by_week: { week_start: string; emotion: string; count: number }[];
  };
  activity_correlation: { activity: string; positive_rate: number; record_count: number }[];
  insights: string[];
}

// ===== 구독 =====
interface VerifySubscriptionResponse {
  is_premium: boolean;
  plan_type: 'monthly' | 'yearly' | null;
  status: 'active' | 'trialing' | 'cancelled' | 'expired' | 'grace_period' | null;
  expires_at: string | null;
}

// ===== 내보내기 =====
interface ExportResponse {
  download_url: string;      // Supabase Storage 서명된 URL (1시간 유효)
  file_name: string;
  file_size_bytes: number;
}
```

#### Edge Function 비즈니스 로직: `recommend-selfcare`

1. 요청에서 `emotion_ids` 추출
2. `users` 테이블에서 `is_premium` 확인
3. `selfcare_emotion_map`에서 해당 감정의 카드를 `relevance_score` 순으로 조회
4. `selfcare_feedback`에서 해당 사용자의 피드백으로 `helpful_rate` 계산: `helpful_count / total_count`
5. `personal_score = relevance_score * 0.4 + helpful_rate * 0.6` (피드백 없으면 `relevance_score` 사용)
6. `daily_card_usage`에서 오늘 사용량 확인 → 무료 사용자는 상위 3개만 반환
7. `daily_card_usage` 카운터 증가 (UPSERT)
8. 정렬된 카드 목록 + `daily_usage` 정보 반환

### 7-7. 상태 관리 구조

| Store | 주요 상태 필드 | 역할 |
|-------|--------------|------|
| **AuthStore** | `user: User \| null`, `isAuthenticated: boolean`, `isLoading: boolean` / Actions: `signIn()`, `signOut()`, `updateProfile()` | 인증 상태 및 사용자 프로필 관리. Supabase Auth 세션 리스닝. |
| **EmotionRecordStore** | `todayRecords: EmotionRecord[]`, `selectedDate: Date`, `isRecording: boolean` / Actions: `createRecord()`, `updateRecord()`, `deleteRecord()`, `fetchRecords()` | 감정 기록 CRUD. WatermelonDB ↔ Supabase 동기화 트리거. TanStack Query로 서버 데이터 캐싱. |
| **MasterDataStore** | `categories: EmotionCategory[]`, `emotions: Emotion[]`, `activities: Activity[]`, `selfcareCards: SelfcareCard[]`, `lastSyncedAt: Date` / Actions: `fetchMasterData()`, `addCustomActivity()` | 마스터 데이터(감정/활동/셀프케어) 로컬 캐싱. 앱 시작 시 버전 비교 후 갱신. |
| **ReportStore** | `weeklySummary: WeeklySummary \| null`, `weeklyReport: WeeklyReport \| null`, `monthlyReport: MonthlyReport \| null` / Actions: `fetchWeeklySummary()`, `fetchWeeklyReport()`, `fetchMonthlyReport()` | 리포트 데이터 관리. report_cache와 연동. TanStack Query로 캐싱. |
| **SubscriptionStore** | `isPremium: boolean`, `planType: string \| null`, `expiresAt: Date \| null`, `trialUsed: boolean` / Actions: `verifySubscription()`, `onPurchaseComplete()` | RevenueCat SDK 상태 동기화. MMKV에 캐시. 오프라인 시 캐시 값 사용. |
| **UIStore** | `isDarkMode: boolean`, `isOnline: boolean`, `syncStatus: 'idle' \| 'syncing' \| 'error'`, `activeTab: string` / Actions: `setOnlineStatus()`, `setSyncStatus()` | 앱 전역 UI 상태. NetInfo 리스닝. 동기화 상태 표시. |

### 7-8. 기능-테이블-API 매핑표

| 기능 ID | 기능명 | 관련 테이블 | API 엔드포인트 | 비고 |
|---------|--------|-----------|---------------|------|
| **F-01** | 감정 태깅 | `emotion_records`, `emotion_record_emotions`, `emotion_record_activities`, `emotions`, `activities` | `POST /rpc/create_emotion_record`, `GET /emotion_records?...`, `PATCH /emotion_records?id=eq.{id}` | RPC 트랜잭션. WatermelonDB 오프라인 우선. |
| **F-02** | 캘린더 & 기본 통계 | `emotion_records`, `emotion_record_emotions`, `emotion_record_activities`, `emotions`, `emotion_categories`, `activities` | `GET /emotion_records?...`, `GET /rpc/get_weekly_summary` | 캘린더: 월별 일괄 조회. 주간 요약: DB Function. |
| **F-03** | 셀프케어 카드 | `selfcare_cards`, `selfcare_emotion_map`, `selfcare_feedback`, `daily_card_usage` | `POST /functions/v1/recommend-selfcare`, `POST /selfcare_feedback`, `GET /selfcare_cards` | Edge Function에서 매핑+개인화+무료 제한 처리. |
| **F-04** | 인증 & 프로필 | `users`, `push_tokens` | `supabase.auth.*`, `POST /functions/v1/complete-onboarding`, `PATCH /users`, `POST /functions/v1/delete-account` | 인증은 SDK. 온보딩/삭제는 Edge Function. |
| **F-05** | 푸시 알림 | `push_tokens`, `users` | `POST /push_tokens`, `DELETE /push_tokens`, pg_cron → Edge Function | 리마인더: 매 정시 발송. 주간 리포트: 월 09:00 KST. |
| **F-06** | 패턴 리포트 | `emotion_records`, `emotion_record_emotions`, `emotion_record_activities`, `emotions`, `emotion_categories`, `activities`, `report_cache` | `GET /functions/v1/weekly-report`, `GET /functions/v1/monthly-report` | Edge Function: 구독 확인 → SQL 집계 → 인사이트 → report_cache. |
| **F-07** | 무제한 카드 | `daily_card_usage`, `subscriptions` | `POST /functions/v1/recommend-selfcare` (F-03 동일) | is_premium 확인 후 제한 해제 + 개인화 순위. |
| **F-08** | 데이터 내보내기 | `emotion_records`, `report_cache` | `POST /functions/v1/export-pdf`, `POST /functions/v1/export-csv` | 구독 확인 → 데이터 집계 → pdf-lib/CSV 생성 → Storage → 서명된 URL. |
| **F-09** | 인앱 결제 | `subscriptions`, `users` | `POST /functions/v1/verify-subscription`, `POST /functions/v1/webhook/revenuecat` | 클라이언트: RevenueCat SDK. 서버: Webhook → DB 업데이트. |

### 7-9. 자체 점검 결과

| # | 점검 항목 | 결과 | 상세 |
|---|----------|------|------|
| 1 | 모든 P0 기능에 AC-XX-X 형식 수용 기준 존재 | **통과** | F-01(AC-01-1~5), F-02(AC-02-1~3), F-03(AC-03-1~3), F-04(AC-04-1~4), F-05(AC-05-1~3), F-06(AC-06-1~4), F-07(AC-07-1), F-08(AC-08-1~2), F-09(AC-09-1~3) |
| 2 | P0 기능별 DB 테이블·API 매핑 존재 | **통과** | 7-8 매핑표에서 F-01~F-09 모두 대응 테이블/API 명시 |
| 3 | DB 스키마 FK 관계 ↔ 데이터 흐름 일치 | **통과** | emotion_records → M:N → emotions/activities, selfcare_emotion_map → emotions/selfcare_cards, selfcare_feedback → records/emotions/cards 모두 FK 정합 |
| 4 | API 엔드포인트 → P0 수용 기준 충족 가능 | **통과** | AC-01-1(RPC+오프라인), AC-03-2(Edge Function daily_card_usage), AC-06-1(Edge Function 구독 검증), AC-09-1(RevenueCat Webhook) |
| 5 | 핵심 API TypeScript 인터페이스 존재 | **통과** | 7-6에 CreateEmotionRecordRequest, RecommendSelfcareResponse, WeeklyReportResponse, MonthlyReportResponse, VerifySubscriptionResponse, ExportResponse 등 정의 |
| 6 | 핵심 DB Function SQL 본문 완성 (스텁 아닌지) | **통과** | create_emotion_record: 55줄 완전한 PL/pgSQL (검증+INSERT 3종+배열순회). get_weekly_summary: 80줄 완전한 PL/pgSQL (5개 집계+JSONB 조립) |
| 7 | 오프라인 저장소·동기화·충돌 해결 정책 명시 | **통과** | 7-3에 WatermelonDB/MMKV 역할 분담, Sync Queue(지수 백오프 1s→2s→4s, 3회 재시도), Server Wins + 미동기화 보존 |
| 8 | 네비게이션 구조 트리 + 핵심 화면 UI 설명 존재 | **통과** | 섹션 8에 Auth/Main/Modal 구조 트리 + 핵심 화면별 UI 구성 명시 |
| 9 | User Story가 모든 기능 영역 커버 | **통과** | 8개 Epic, 24개 Story — 온보딩(3), 감정기록(5), 캘린더(3), 셀프케어(2), 프리미엄(3), 설정(3), 결제(3), 알림(2) |

---

## 8. Screen Map & UI 명세

### 8-1. 네비게이션 구조 트리

```
Root Navigator (Stack)
├── Auth Stack (미인증 시)
│   ├── SplashScreen                    → 앱 로딩, 세션 확인
│   ├── LoginScreen                     → 카카오/Apple/이메일 로그인
│   └── OnboardingFlow (Stack)
│       ├── OnboardingStep1_EmotionGuide → 감정 체계 안내 (7대 분류 소개)
│       ├── OnboardingStep2_FirstRecord  → 첫 감정 기록 체험
│       └── OnboardingStep3_Notification → 알림 시간 설정 + 완료
│
├── Main Tab Navigator (인증 시, Bottom Tabs)
│   ├── HomeTab (홈/기록)
│   │   ├── HomeScreen                  → 오늘의 감정 요약 + 빠른 기록 CTA
│   │   └── RecordDetailScreen          → 기록 상세 보기/수정
│   │
│   ├── CalendarTab (캘린더)
│   │   ├── CalendarScreen              → 월별 감정 캘린더
│   │   └── DayDetailScreen             → 특정 날짜 기록 리스트
│   │
│   ├── SelfcareTab (셀프케어)
│   │   └── SelfcareScreen              → 셀프케어 카드 목록 + 피드백
│   │
│   ├── ReportTab (리포트)
│   │   ├── ReportScreen                → 주간/월간 리포트 (무료: 기본, 유료: 상세)
│   │   └── ReportDetailScreen          → 리포트 상세 (패턴, 인사이트)
│   │
│   └── SettingsTab (설정)
│       ├── SettingsScreen              → 프로필, 알림, 구독, 보안, 기타
│       ├── ProfileEditScreen           → 닉네임/연령대 수정
│       ├── NotificationSettingsScreen  → 알림 시간/종류 설정
│       ├── SubscriptionScreen          → 구독 관리/결제
│       ├── AppLockScreen               → 생체인식/PIN 설정
│       ├── ExportScreen                → PDF/CSV 내보내기 (프리미엄)
│       └── AccountDeleteScreen         → 계정 삭제
│
└── Modal Stack (전역)
    ├── EmotionRecordModal              → 감정 기록 입력 (풀스크린 모달)
    ├── SelfcareDetailModal             → 셀프케어 카드 상세
    ├── PaywallModal                    → 프리미엄 구독 유도
    └── ShareCardModal                  → 공유 카드 미리보기 + 공유 (P1)
```

### 8-2. 핵심 화면별 UI 구성

#### HomeScreen (홈)
- **상단**: 인사 문구 ("오늘의 마음날씨는?"), 날짜 표시
- **중앙**: 오늘 기록한 감정 요약 카드 (없으면 빈 상태 + "감정 기록하기" CTA), 최근 셀프케어 카드 1개 (오늘 기록 기반)
- **하단**: 주간 미니 캘린더 (최근 7일 감정 아이콘), 기록 streak 카운터
- **FAB (Floating Action Button)**: "+" 감정 기록 시작 → EmotionRecordModal
- **데이터**: `emotion_records` (오늘), `get_weekly_summary` (이번 주)
- **API**: `GET /emotion_records?recorded_at=gte.{today}`, `GET /rpc/get_weekly_summary`

#### EmotionRecordModal (감정 기록 — 풀스크린 모달)
- **Step 1 상단**: "지금 어떤 감정이에요?" 타이틀, 시간 표시 (수동 변경 가능)
- **Step 1 중앙**: 감정 대분류 7종 (날씨 아이콘 가로 스크롤) → 탭 시 소분류 펼침 → 소분류 칩 1~3개 선택
- **Step 2**: 활동 태그 그리드 (기본 20종 아이콘 + "+" 커스텀 추가), 한줄 메모 입력 (선택, 200자)
- **하단**: "저장" 버튼 → 저장 후 셀프케어 카드 표시
- **데이터**: `emotion_categories`, `emotions`, `activities`
- **API**: `POST /rpc/create_emotion_record`, `POST /functions/v1/recommend-selfcare`

#### CalendarScreen (캘린더)
- **상단**: 월 선택 (좌우 화살표), 년/월 표시
- **중앙**: 월별 캘린더 그리드 — 각 날짜 셀에 주요 감정 아이콘/색상 점 표시
- **하단**: 선택한 날짜의 감정 기록 미리보기 (최대 3개), 탭 시 DayDetailScreen 이동
- **데이터**: `emotion_records` (월별), `emotions`, `emotion_categories`
- **API**: `GET /emotion_records?recorded_at=gte.{month_start}&recorded_at=lt.{month_end}`

#### ReportScreen (리포트)
- **상단**: 탭 전환 (주간 | 월간)
- **주간 (무료)**: 감정 빈도 Top 3 바 차트, 긍정/부정 비율 도넛 차트, 활동 Top 3
- **주간 (유료 상세)**: 요일별 감정 히트맵, 시간대별 패턴, 활동-감정 상관관계, 인사이트 카드 1~3개, 전주 대비 변화
- **월간 (유료)**: 주별 감정 추이 라인 차트, 월간 감정 분포, 활동 상관관계 Top 5
- **무료 사용자**: 기본 주간 요약만 표시, 상세 영역은 블러 처리 + "프리미엄으로 잠금 해제" PaywallModal
- **데이터**: `get_weekly_summary` (무료), `report_cache` (유료)
- **API**: `GET /rpc/get_weekly_summary`, `GET /functions/v1/weekly-report`, `GET /functions/v1/monthly-report`

#### SettingsScreen (설정)
- **프로필 섹션**: 닉네임, 연령대 → ProfileEditScreen
- **알림 섹션**: 기록 리마인더 시간, 주간 리포트 알림 ON/OFF → NotificationSettingsScreen
- **구독 섹션**: 현재 플랜, 구독 관리 → SubscriptionScreen
- **보안 섹션**: 앱 잠금 ON/OFF, 잠금 방식 → AppLockScreen
- **데이터 섹션**: PDF/CSV 내보내기 → ExportScreen (프리미엄)
- **계정 섹션**: 로그아웃, 계정 삭제 → AccountDeleteScreen
- **기타**: 개인정보 처리방침, 서비스 이용약관, 앱 버전
- **데이터**: `users`, `subscriptions`
- **API**: `GET /users?id=eq.{uid}`, `PATCH /users?id=eq.{uid}`

---

## 9. 경쟁 차별화 전략

### 9-1. 포지셔닝 맵

```
                  행동 제안 중심
                      ↑
                      │
      마음날씨 ★      │     라일리하루
     (기록+분석+행동)   │   (AI 멀티모달 분석)
                      │
 기록 중심 ──────────┼──────────── 분석/상담 중심
                      │
      하루콩          │     마인드카페
     (기록+캐릭터)     │    (전문 상담)
      루빗            │     트로스트
     (습관+AI 위로)    │    (AI챗봇+상담)
                      │
                  기록/저장 중심
```

### 9-2. 핵심 차별점 3가지

| # | 차별점 | 상세 | 경쟁사 대비 |
|---|--------|------|------------|
| 1 | **한국어 감정 어휘 체계** | 대분류 7종 → 소분류 36종. '서운함', '답답함', '억울함', '눈치 보임' 등 한국 고유 감정 반영 | 하루콩/데일리오: 영어권 감정 분류 번역 수준. 라일리하루: AI 기반이나 한국어 특화 어휘 체계 미구축 |
| 2 | **기록→분석→행동 완결 루프** | 감정 태깅(10초) → 패턴 분석(주간/월간) → 셀프케어 행동 카드(피드백 기반 개인화) | 하루콩: 기록→끝. 무디: 기록→퀘스트(게이미피케이션). 루빗: 습관 중심. 라일리하루: 분석 중심(행동 제안 약함) |
| 3 | **데이터 기반 셀프케어 개인화** | 감정별 행동 카드 100개+ 풀 × 피드백 루프(`helpful_rate * 0.6 + relevance * 0.4`) | 마보: 명상 콘텐츠만. 트로스트: 챗봇 위로. 무디: 규칙 기반 퀘스트(피드백 루프 없음) |

### 9-3. 라일리하루 대비 차별화 (가장 유사한 경쟁자)

| 비교 항목 | 마음날씨 | 라일리하루 |
|-----------|---------|-----------|
| 출시일 | 2026 H1 (예정) | 2024.12 |
| 감정 입력 | 한국어 특화 36종 터치 태그 (10초) | 텍스트/음성/사진 멀티모달 AI 분석 |
| 분석 방식 | SQL 집계 기반 패턴 분석 (결정론적) | 자체 LLM 기반 감정 분석 |
| 행동 제안 | 100개+ 셀프케어 카드 풀, 피드백 개인화 | AI 코멘트/조언 (행동 카드 없음) |
| 가격 | 무료+프리미엄 ₩3,500/월 | 무료+프리미엄 (추정 유사 가격대) |
| **차별 초점** | **행동 제안(What to do) + 한국어 감정 체계** | **감정 분석(What I feel) + AI 기술력** |

**전략**: 라일리하루가 "감정을 정확히 읽어주는 것"에 집중한다면, 마음날씨는 "감정을 읽은 후 무엇을 할 것인가"에 집중. 감정 인식이 아닌 감정 대응(action)에서 차별화.

---

## 10. 수익 모델

### 10-1. 프리미엄 구독

| 항목 | 무료 (Free) | 프리미엄 (Premium) |
|------|------------|-------------------|
| 감정 기록 | ✅ 무제한 | ✅ 무제한 |
| 감정 캘린더 | ✅ | ✅ |
| 주간 기본 요약 | ✅ (Top 3 감정, 긍정/부정 비율) | ✅ |
| 셀프케어 카드 | ✅ 3개/일 | ✅ 무제한 + 개인화 랭킹 |
| AI 상세 패턴 리포트 | ❌ | ✅ 주간/월간 |
| 감정-활동 상관관계 | ❌ | ✅ |
| 데이터 내보내기 | ❌ | ✅ PDF/CSV |
| 리포트 공유 카드 | ❌ | ✅ (P1) |

### 10-2. 가격 정책

| 플랜 | 가격 | 비고 |
|------|------|------|
| 월간 | ₩3,500 | 심리상담(3~10만원/회) 대비 1/10 이하 |
| 연간 | ₩27,900 (₩2,325/월) | 월간 대비 33% 할인 |
| 무료 체험 | 7일 | 결제 정보 입력 후 체험 시작 |

### 10-3. 수익 목표 (보수적)

| 시점 | MAU | 유료 전환율 | 유료 사용자 | MRR |
|------|-----|-----------|-----------|-----|
| 출시 3개월 | 5,000 | 3% | 150 | ₩525,000 |
| 출시 6개월 | 15,000 | 4% | 600 | ₩2,100,000 |
| 출시 12개월 | 30,000~50,000 | 5% | 1,500~2,500 | ₩5,250,000~8,750,000 |

> 감정 기록 앱 유료 전환율 벤치마크: 건강&피트니스 앱 DL→유료 9.4% (Sensor Tower), 한국 시장은 3~5% 보수적 적용.

### 10-4. 수익 모델 강화 방안 (향후)

1. **캐릭터/테마 판매**: 감정 날씨 캐릭터 스킨, 계절 테마 (하루콩 수익 모델 참조). 단가 ₩1,000~3,000
2. **기업 B2B**: 임직원 감정 관리 대시보드 (익명 통계). 기업 멘탈 헬스 예산 연계
3. **콘텐츠 파트너십**: 명상 앱(마보), 심리상담 앱(마인드카페) 연결 수수료

---

## 11. 리스크 매트릭스

| # | 리스크 | 영향도 | 발생 확률 | 대응 전략 |
|---|--------|--------|----------|----------|
| R-01 | **경쟁 심화**: 라일리하루, 블루시그넘(하루콩) AI 확장 | 높음 | 높음 | 행동 제안(셀프케어 카드) 차별화 집중. 한국어 감정 어휘 데이터 축적으로 moat 구축. 빠른 MVP 출시로 선점 |
| R-02 | **낮은 유료 전환율**: 감정 기록 앱 유료 전환 3% 미만 | 높음 | 중간 | 무료↔유료 가치 격차 명확화(블러 처리). 7일 무료체험. 캐릭터/테마 부분 유료화 병행 검토 |
| R-03 | **리텐션 저하**: 감정 기록 습관 형성 실패 (D30 < 20%) | 높음 | 중간 | 10초 기록 UX 최적화. 푸시 리마인더 개인화. streak 보상. 셀프케어 카드의 즉각적 가치 제공 |
| R-04 | **개인정보 이슈**: 감정 데이터 유출/오남용 우려 | 높음 | 낮음 | Supabase RLS 철저 적용. HTTPS(TLS 1.3). 앱 잠금(생체인식/PIN). 개인정보 처리방침 투명 공개. KISA 가이드 준수 |
| R-05 | **1인 개발 병목**: 개발/디자인/마케팅 동시 수행 부담 | 중간 | 높음 | P0 기능에만 집중. 디자인: 기존 RN 컴포넌트 라이브러리 활용. 마케팅: 커뮤니티(에브리타임, 블라인드) 바이럴 우선 |
| R-06 | **앱스토어 심사 리젝**: 건강/의료 카테고리 가이드라인 위반 | 중간 | 낮음 | "의료 기기/진단 도구가 아님" 명시. "셀프케어 제안"으로 포지셔닝(치료/처방 아님). Apple Health 연동 시 별도 리뷰 대비 |

---

## 12. 전제 조건 & 제약 사항

### 전제 조건
1. Supabase 무료/Pro 플랜으로 MVP 트래픽 충분히 수용 가능 (무료: 500MB DB, 50K MAU Auth, 500MB Storage)
2. RevenueCat 무료 티어로 인앱 결제 구현 가능 (월 $2,500 MTR까지 무료)
3. Expo Push Notification으로 iOS/Android 푸시 통합 가능
4. 한국어 감정 어휘 36종은 심리학 문헌(플루칙 감정 바퀴 + 한국 감정 연구) 기반 자체 구성으로 충분
5. 1인 개발자가 React Native + Supabase 스택에 숙련도 보유

### 제약 사항
1. **플랫폼**: iOS 15+, Android 10+ (하위 버전 미지원)
2. **언어**: 한국어 단일 언어 (글로벌화는 향후 과제)
3. **AI/ML**: MVP에서 AI/ML 모델 사용 안 함. SQL 집계 기반 패턴 분석만 구현
4. **외부 연동**: MVP에서 외부 건강 플랫폼(Apple Health, Google Fit) 연동 안 함
5. **법적**: 의료 행위가 아닌 셀프케어 제안으로 한정. 자해/자살 위험 감지 시 전문 기관 안내만 제공 (진단/치료 기능 없음)
6. **인프라**: Supabase 관리형 서비스에 전적으로 의존. 자체 서버 운영 없음

---

## 13. 범위 제외 (Out of Scope)

MVP에서 구현하지 않는 항목:

| # | 항목 | 제외 사유 | 향후 검토 시점 |
|---|------|----------|--------------|
| 1 | LLM 기반 개인화 인사이트 문구 | SQL 집계만으로 MVP 가치 검증 가능. API 비용 부담 | 유료 전환율 5% 달성 후 |
| 2 | 소셜 기능 (친구, 커뮤니티) | 감정 데이터의 프라이버시 우려. MVP 복잡도 증가 | MAU 5만 달성 후 |
| 3 | Apple Health / Google Fit 연동 | 외부 플랫폼 심사 요건 추가. MVP 범위 초과 | v2.0 |
| 4 | 웹 버전 | 모바일 앱 우선. 웹은 수요 확인 후 | MAU 10만 달성 후 |
| 5 | 다국어 지원 | 한국어 감정 어휘 특화가 핵심 차별점. 번역 시 가치 희석 | 한국 시장 안정화 후 |
| 6 | 전문 상담사 연결 | 법적 리스크(의료법). 파트너십 필요 | 별도 사업 검토 |
| 7 | 음성/사진 감정 입력 | 멀티모달 AI 필요. 라일리하루와의 경쟁 영역 | LLM 통합 후 검토 |
| 8 | 위젯 (iOS/Android) | 구현 복잡도 대비 MVP 핵심 아님 | v1.5 |

---

## 14. MVP 로드맵

### Phase 1: 핵심 기록 (1~4주)

| 주차 | 작업 | 산출물 |
|------|------|--------|
| 1주 | 프로젝트 세팅(Expo + TypeScript + Supabase), DB 스키마 생성, RLS 정책 적용 | 개발 환경 완성, 빈 앱 실행 |
| 2주 | 인증(카카오/Apple/이메일), 온보딩 3스텝 UI, 프로필 설정 | F-04 완성 |
| 3주 | 감정 태깅 UI(대분류→소분류 칩, 활동 태그, 메모), create_emotion_record RPC | F-01 완성 |
| 4주 | 감정 캘린더 뷰, 타임라인, 주간 기본 요약(get_weekly_summary) | F-02 완성 |

### Phase 2: 셀프케어 & 오프라인 (5~8주)

| 주차 | 작업 | 산출물 |
|------|------|--------|
| 5주 | 셀프케어 카드 데이터 입력(100개+), 규칙 기반 매핑, recommend-selfcare Edge Function | F-03 완성 |
| 6주 | WatermelonDB 오프라인 저장소 통합, Sync Queue 구현 | 오프라인 우선 아키텍처 |
| 7주 | 푸시 알림(Expo Push, 기록 리마인더, 주간 리포트 알림) | F-05 완성 |
| 8주 | 통합 테스트, 버그 수정, UX 폴리시 | Phase 2 안정화 |

### Phase 3: 프리미엄 & 출시 (9~12주)

| 주차 | 작업 | 산출물 |
|------|------|--------|
| 9주 | AI 패턴 리포트 Edge Function(weekly-report, monthly-report), report_cache | F-06 완성 |
| 10주 | RevenueCat 인앱 결제 연동, Paywall UI, 무료체험 플로우 | F-09, F-07 완성 |
| 11주 | PDF/CSV 내보내기(pdf-lib, Storage signed URL), 다크 모드 | F-08 완성 |
| 12주 | QA, 앱스토어 심사 제출, 랜딩 페이지 | **MVP 출시** |

### Phase 4: 성장 (출시 후)

- 공유 카드 기능 (F-10, P1)
- 캐릭터/테마 판매 (수익 다각화)
- 사용자 피드백 기반 감정 어휘 확장
- LLM API 통합 (개인화 인사이트 문구)

---

## 15. 성공 지표

### 15-1. 핵심 KPI (출시 후 6개월 기준)

| 카테고리 | 지표 | 목표 | 측정 방법 |
|----------|------|------|----------|
| **획득** | 총 다운로드 | 50,000+ | App Store Connect / Google Play Console |
| **활성화** | 온보딩 완료율 | ≥ 70% | 온보딩 Step 3 완료 / 가입 수 |
| **활성화** | 첫 감정 기록 전환율 | ≥ 60% | 첫 기록 완료 / 온보딩 완료 수 |
| **리텐션** | D1 리텐션 | ≥ 40% | 가입 다음날 앱 오픈 |
| **리텐션** | D7 리텐션 | ≥ 25% | 가입 7일 후 앱 오픈 |
| **리텐션** | D30 리텐션 | ≥ 15% | 가입 30일 후 앱 오픈 |
| **참여** | 주간 기록 횟수/유저 | ≥ 4회 | 주간 기록 수 / WAU |
| **참여** | 셀프케어 카드 "도움됨" 비율 | ≥ 50% | helpful 피드백 / 전체 피드백 |
| **수익** | 유료 전환율 | ≥ 3% | 유료 구독 / MAU |
| **수익** | MRR | ₩5,250,000 (12개월) | RevenueCat 대시보드 |
| **만족** | 앱스토어 평점 | ≥ 4.5 | App Store / Play Store |

### 15-2. 실패 기준 (Pivot 검토 트리거)

| 지표 | 기준 | 대응 |
|------|------|------|
| D7 리텐션 < 10% | 출시 3개월 시점 | 감정 기록 UX 전면 재설계 또는 피벗 검토 |
| 유료 전환율 < 1% | 출시 6개월 시점 | 수익 모델 변경 (광고, 캐릭터 판매 등) |
| 셀프케어 "도움됨" < 30% | 출시 3개월 시점 | 카드 콘텐츠 전면 교체, 전문가 감수 |
| MAU < 3,000 | 출시 6개월 시점 | 마케팅 채널/메시지 변경 또는 피벗 검토 |

---

## 부록

### 부록 A. 한국어 감정 어휘 체계 (7대 분류 → 36종)

| 대분류 | 소분류 감정 |
|--------|-----------|
| ☀️ 기쁨 (Joy) | 행복한, 신나는, 뿌듯한, 감사한, 설레는 |
| 🌤️ 평온 (Calm) | 편안한, 만족한, 여유로운, 평화로운, 무덤덤한 |
| 🌧️ 슬픔 (Sadness) | 슬픈, 외로운, 서운한, 허전한, 우울한 |
| ⛈️ 분노 (Anger) | 화나는, 짜증나는, 억울한, 답답한, 열받는 |
| 🌫️ 불안 (Anxiety) | 불안한, 걱정되는, 초조한, 긴장되는, 두려운 |
| 🌪️ 스트레스 (Stress) | 지친, 피곤한, 부담되는, 눈치 보이는, 압도당하는 |
| 🌈 기대 (Anticipation) | 기대되는, 호기심 가득한, 용기나는, 결심한, 희망찬, 의욕적인 |

> 총 36종. 대분류별 5~6종. 한국 심리학 연구(한국판 정서 단어 목록)와 플루칙 감정 바퀴를 기반으로 구성. 한국 고유 감정('서운하다', '답답하다', '억울하다', '눈치 보이다')을 명시적으로 포함.

### 부록 B. 셀프케어 카드 분류 (100개+ 예시)

| 감정 대분류 | 카드 예시 (각 5개 발췌) |
|------------|----------------------|
| 슬픔 | 따뜻한 차 한잔 마시기, 좋아하는 음악 듣기, 산책 10분, 친한 친구에게 연락하기, 포근한 이불 속에서 쉬기 |
| 분노 | 깊은 호흡 5회, 찬물로 세수하기, 감정 일기 쓰기, 스트레칭 5분, 그 상황에서 벗어나기 |
| 불안 | 4-7-8 호흡법, 발바닥 느끼기(그라운딩), 지금 보이는 것 5가지 말하기, 따뜻한 물 마시기, 좋아하는 향기 맡기 |
| 스트레스 | 업무 우선순위 3개만 쓰기, 짧은 낮잠 15분, 좋아하는 간식 먹기, 하늘 보기, 오늘 잘한 것 3가지 쓰기 |
| 기쁨/평온 | 감사 일기 쓰기, 좋아하는 사람에게 고마움 전하기, 이 순간 사진 찍기, 새로운 것 시도하기, 기분 좋은 이유 메모하기 |

> 카드는 **즉시 실행 가능한 행동**(5~15분 이내)으로 구성. 전문 상담/치료 행위 포함하지 않음.

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 |
|------|------|----------|
| 1.0 | 2026-01-30 | 초안 작성 (14개 섹션) |
| 2.0 | 2026-01-30 | Stage 4 리뷰 반영: DB Function SQL 본문 추가, PDF/공유카드 기술 명세, 온보딩 상세화 |
| 3.0 | 2026-01-31 | Stage 3 재작성: 15개 섹션 완성. User Story 7→24개(8 Epic). Screen Map & UI 명세 신규. DB Function 완전한 SQL 본문. Zustand Store 정의. TypeScript 인터페이스. 기능-테이블-API 매핑표. 자체 점검 9항목 통과 |
